# chapter 2. 리팩터링 원칙

> **리팩터링**
> 
> [명사] 소프트웨어의 겉보기 동작은 그대로 유지한 채 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 방법

위에서 제시한 정의를 따를면 특정한 방식에 코드를 정리하는 것만이 리팩터링이다. 

코드가 항상 정상 작동하기 때문에 전체 작업이 끝나지 않았더라도 언제든 멈출 수 있다.

저자는 코드베이스를 정리하거나 구조를 바꾸는 모든 작업을 **재구성(Restructuring)** 이라는 포괄적인 단어를 사용하며, **리팩터링** 은 하나의 특수한 형태로 본다고 한다.

### 두개의 모자

**진척도**는 테스트를 추가해서 통과하는지 확인하는 방식으로 측정한다. 

반면 **리팩터링** 을 할 때는 '리팩터링'모자를 쓴 다음 절대 기능 추가를 하지 않기로 다짐한 뒤 오로지 코드 재구성에만 전념한다.

> 실무를 해본사람들에겐 두개의 모자 비유가 정말 적합하다, 단계를 명확히하는게 굉장히 중요하다. - 토비

--- 

### 리팩터링을 하는 이유

리팩터링이 소프트웨어의 모든 문제점을 해결하는 만병통치약은 아니다. 하지만 코드를 **건강한 상태**로 유지하는 데 도와주는 약은 분명하다.

#### 리팩터링하면 소프트웨어 설계가 좋아진다.

같은 일을 하더라도 설계가 나쁘면 코드가 길어지기 쉽다. 따라서 리팩터링의 중복 코드 제거는 설계 개선 작업의 중요한 한 축을 차지한다.

비슷한 일을 하는 코드가 여러곳에 있다면 한 부분만 살짝 바꿔서는 시스템이 예상대로 작동하지 않을 수 있다. 반면 중복 코드를 제거하면 모든 코드가 언제나 고유한 일을 수행함을 보장할 수 있으며 이는 바람직한 설계의 핵심이다.

#### 리팩터링하면 소프트웨어를 이해하기 쉬워진다.

프로그래밍은 여러 면에서 마치 컴퓨터와 대화하는 것과 같다. 컴퓨터에게 시킬 일을 표현하는 코드를 작성하면 컴퓨터는 정확히 시킨대로 반응한다.

문제는 프로그램을 동작시키는데만 신경 쓰다보면 나중에 그 코드를 다룰 개발자를 배려하지 못한다. 물론 이 개발자가 나 자신이 될 수도 있으므로 리팩터링은 중요하다.

#### 리팩터링하면 버그를 쉽게 찾을 수 있다.

코드를 이해하기 쉽다는 말은 버그를 찾기 쉽다는 말이기도 하다.

켄트 벡은 "난 뛰어난 프로그래머가 아닙니다. 단지 뛰어난 습관을 지닌 괜찮은 프로그래머일 뿐입니다."라고 말한 적도 있다.

#### 리팩터링하면 프로그래밍 속도를 높일 수 있다.

한 시스템을 오래 개발 중인 개발자들과 이야기하다보면 초기에는 진척이 빨랐지만 현재는 새 기능을 하나 추가하는 데 훨씬 오래 걸린다는 말을 많이 한다.

![](https://velog.velcdn.com/images%2Fken1204%2Fpost%2Fa432cd77-5554-4748-972d-b1e96ce155c0%2Fimage.png)

---

### 언제 리팩터링 해야할까?

#### 준비를 위한 리팩터링: 기능을 추가하기 쉽게 만들기

리팩터링하기 가장 좋은 시점은 코드베이스에 기능을 새로 추가하기 직전이다.

코드를 살펴보면서 구조를 살짝 바꾸면 다른 작업을 하기가 훨씬 쉬워질 만한 부분을 찾으면된다.

버그를 잡을 때도, 오류를 일으키는 코드가 복제되어 퍼져 있다면 우선 한 곳으로 합치는 편이 작업하기에 훨씬 편하다.

#### 이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들기

코드를 수정하려면 먼저 그 코드가 하는 일을 파악해야한다. 

이 작업을 거치면 어느정도 코드를 이해하게 된다. 리팩터링을 하면 머리로 이해한 것을 코드에 옮겨담을 수 있다고 한다. 그런 다음 수정한 코드를 테스트해보면 생각이 맞았는 지 확인도 가능하다.

이해를 한 후에 진행되는 코드 수정은 훨씬 오래 보존되며 동료들도 이해하기 쉬운 코드가 된다.

#### 쓰레기 줍기 리팩터링

코드에서 리팩터링 할 점이 발견되어도 모두 그 즉시 수정하는 것은 효율적이지 않다.

간단히 수정할 수 있는 것은 즉시 고치고, 시간이 좀 걸리는 일은 짧은 메모만 남긴 다음 하던 일을 끝내고 나서 처리한다. 이것이 이해를 위한 리팩터링의 변형인 **쓰레기 줍기 리팩터링**이다.

리팩터링의 멋진 점은 각각의 작은 단계가 코드를 깨트리지 않는다는 사실이다.

#### 계획된 리팩터링과 수시로 하는 리팩터링

리팩터링 일정을 따로 잡아두지 않고, 기능을 추가하거나 버그를 잡는 동안 리팩터링도 함께한다. 대부분의 리팩터링을 다른 일을 하는 중에 처리하는 것이 좋다.

> 보기 싫은 코드를 발견하면 리팩터링하자. 그런데 잘 작성된 코드 역시 수많은 리팩터링을 거쳐야한다.

뛰어난 개발자는 새 기능을 추가히기 쉽도록 코드를 '수정'하는 것이 그 기능을 가장 빠르게 추가하는 길일 수 있음을 안다

물론 리팩터링에 소홀했다면, 따로 시간을 내서 새 기능을 추가하기 쉽도록 코드베이스를 개선할 필요가 있다.

하지만 이런 이유로 계획된 리팩터링을 하게 되는 일은 최소한으로 줄여야한다. 리팩터링은 **기회가 될 때마다 해야한다.**

#### 오래 걸리는 리팩터링

라이브러리를 새 것으로 교체하는 작업일 수도 있고, 일부 코드를 다른 팀과 공유하기 위해 컴포넌트로 빼내는 작업일 수도 있다.

이런 상황에서도 팀 전체가 리팩터링 하는것에 매달리는 것은 회의적이다. 

그보다는 주어진 문제를 몇 주에 걸쳐 조금씩 해결해가는 편이 효과적이다. 누구든지 리팩터링 해야할 코드와 관련한 작업을 하게 될 때 마다 원하는 방향으로 조금씩 개선하는 식이다.

#### 코드 리뷰에 리팩터링 활용하기

잘 짜여진 코드 리뷰는 깔끔한 코드를 작성하는 데에도 굉장히 중요하다. 코드 리뷰를 하면 다른 사람의 아이디어를 얻을 수 있다는 장점도 있다. 

지금은 새로운 아이디어가 떠오르면 리팩터링하여 쉽게 구현해넣을 수 있는지부터 살펴본다. 쉽다면 실제로 리팩터링을 한다.

#### 리팩터링 하지 말아야 할 때

1. 외부 API 다루듯 호출해서 쓰는 코드. 리팩터링은 내부 동작을 이해해야 할 시점에 하는 것이 효과적이다.
2. 리팩터링 하는 것보다 처음부터 새로 작성하는 게 쉬울 때

---

### 리팩터링 시 고려할 문제

#### 새 기능 개발 속도 저하

리팩터링의 궁극적인 목적은 개발 속도를 높여서, 더 적은 노력으로 더 많은 가치를 창출하는 것이다.

개발 속도 저하를 이유로 리팩터링을 금하는 비생산적인 문화를 관리자 탓으로 돌리는 사람이 많지만 오히려 개발자 스스로가 그렇게 생각하는 경우도 더러 있다.

> 팀원 전체가 리팩토링을 하겠다는 것은 받아들이기 힘든 표현이다. (일을 제대로안했나?) 그래서 계획된 리팩토링을 잡는 것이 은근히 어렵다. 그리고 그렇게 계획 잡은 날에는 급한일들이 생겨버리면 계획된 리팩토링을 수행하기 쉽지않다.
> 
> 꿀팁 : 리팩토링을 하기 위해서 시간이 필요하다면 매니저에게 개발 일정의 완료 진척도를 어느정도 여유있게 보고해라 . (실제로 기능은 100%됐더라도 70%로 보고하면 어느정도 여유가생긴다고함) - 근데 요즘은 깃에 다 나와서 쉽지않긴함


#### 코드 소유권

함수를 호출하는 코드의 소유자가 다른 팀이라서 나에게는 쓰기 권한이 없을 수 있다.

이런 경우에는 기존 함수를 그대로 유지하되, 그 내부에서 리팩터링한 함수를 호출하는 방식으로 수정해야한다.

따라서 저자는 코드 소유권을 작은 단위로 나눠 엄격히 관리하는데에 반대하는 입장이다.

#### 테스팅

리팩터링의 두드러진 특성은 프로그램의 겉보기 동작은 똑같이 유지된다는 것이다. 

이 유지되는 점을 확보하려면 견고한 테스트를 마련해야한다.

뛰어난 자동 리팩터링을 제공하는 환경이라면 굳이 테스트하지 않아도 오류가 생기지 않는다고 확신할 수 있다.
